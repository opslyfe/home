#!/bin/sh

storage=${SECRET_STORAGE:-$HOME/.secrets}
copy=true

if [ "$1" = "--no-copy" ] && [ -n "$2" ]; then
	copy=false
	shift
fi

if [ -z "$1" ]; then
	printf "%s\n" "$storage"/*.gpg | sed 's/.*\/\(.*\)\.gpg/\1/'
	exit 0
fi

[ -e "$storage/$1.gpg" ] && {
	if $copy; then
		gpg -dq < "$storage/$1.gpg" | wl-copy
	else
		gpg -dq < "$storage/$1.gpg"
	fi
	exit 0
}

printf "%s (%s): " "creating new secret" "$1"
stty -echo
read -r new_secret

printf "\n%s: " "retype new secret"
read -r retype_secret
[ "$new_secret" = "$retype_secret" ] || {
	printf "%s\n" "secrets dont match"
	exit 1
}

printf "%s" "$new_secret" | gpg -e -r "secret storage" > "$storage/$1.gpg"
printf "\n"

stty echo
